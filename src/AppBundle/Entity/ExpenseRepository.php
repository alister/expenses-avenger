<?php
namespace AppBundle\Entity;

use Doctrine\ORM\EntityRepository;
use AppBundle\Entity\Expense;

/**
 * ExpenseRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ExpenseRepository extends EntityRepository
{
    public function save(Expense $expense)
    {
        $this->_em->persist($expense);
        $this->_em->flush();
    }

    public function remove(Expense $expense)
    {
        $this->_em->remove($expense);
        $this->_em->flush();
    }

    public function fetchByDate(User $user, \DateTime $startDate, \DateTime $endDate, $order = 'DESC')
    {
        $order = strtoupper($order);
        // verify the only values allowed
        if (! in_array($order, ['ASC', 'DESC'])) {
            $order = 'DESC';
        }
        return $this->getEntityManager()->createQuery(
                'SELECT e
                FROM AppBundle:Expense e
                WHERE 
                    e.user = :user AND 
                    e.createdAt >= :startCreatedAt AND 
                    e.createdAt <= :endCreatedAt
                ORDER BY e.createdAt ' . $order
            )
            ->setParameter('user', $user)
            ->setParameter('startCreatedAt', $startDate)
            ->setParameter('endCreatedAt', $endDate)
            //#->setParameter('orderBy', $order)
            ->getResult();
    }
}
